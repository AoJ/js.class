<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>JS.Class tests</title>
    <script src="prototype.js" type="text/javascript" charset="utf-8"></script>
    <script src="unittest.js" type="text/javascript" charset="utf-8"></script>
    <script src="build/class.js" type="text/javascript" charset="utf-8"></script>
    <script src="build/patterns.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="test.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <script type="text/javascript" charset="utf-8">
        
        var Animal = JS.Class({
            extend: {
                find: function(thing) { return 'Animal finds ' + thing; },
                create: function(thing) { return this.find(thing) + ' and Animal creates ' + thing; }
            },
            initialize: function(name) {
                this.name = String(name);
            },
            speak: function(stuff) {
                return 'My name is ' + this.name + ' and I like ' + stuff;
            }
        });
        
        var Bear = JS.Class(Animal, {
            extend: {
                create: function(thing) {
                    return this._super(thing) + ', but Bear creates other stuff'
                }
            },
            speak: function(stuff) {
                return this._super(stuff).toUpperCase();
            }
        });
        
        var NoSuperBear = JS.Class(Bear, {
            speak: function() { return this.name.toUpperCase(); }
        });
        
        var Koala = JS.Class(Bear, {
            speak: function(stuff) {
                return "I'm not really a Bear, but I do like " + stuff;
            }
        });
        
        var Dog = new JS.Class(Animal, {
            bark: function() { return this.name + ' says WOOF!'; }
        });
        
        Dog.Interface = new JS.Interface(['speak', 'bark']);
        
        var Pitbull = JS.Class(Dog, {
            extend: {
                canBiteYourLegsOff: function() {
                    return this.biting;
                },
                biting: 'Of course it can'
            },
            speak: function() {
                return this._super();
            }
        });
        
        var Camel = new JS.Singleton(Animal, {
            fillHumpsWithWater: function() {}
        });
        
        //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        
        // Let's implement the classes from here: http://www.ajaxpath.com/javascript-inheritance
        // and make sure Crockford's problems aren't encountered.
        
        var BaseClass = JS.Class({
            getName: function() { return 'BaseClass(' + this.getId() + ')'; },
            getId: function() { return 1; }
        });
        
        var SubClass = JS.Class(BaseClass, {
            getName: function() {
                return 'SubClass(' + this.getId() + ') extends ' + this._super();
            },
            getId: function() { return 2; }
        });
        
        var TopClass = JS.Class(SubClass, {
            getName: function() {
                return 'TopClass(' + this.getId() + ') extends ' + this._super();
            },
            getId: function() {
                return this._super();
            }
        });
        
        //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        
        var NativeClass = function() {};
        NativeClass.prototype = {
            getName: function() { return 'Native'; }
        };
        
        var ChildOfNativeClass = JS.Class(NativeClass, {
            getName: function() {
                return this._super();
            }
        });
        
        //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        
        var Paginator = JS.Class({
            initialize: function(n) {
                this.count = n;
                this.createItems(n);
            },
            createItems: function(n) {
                this.items = this.items || [];
                for (var i = 0; i < n; i++)
                    this.items.push(new this.klass.Item(i));
            }
        });
        
        Paginator.Item = JS.Class({
            initialize: function(n) {
                this.name = 'Item';
                this.number = n;
            },
            getName: function() {
                return this.name + ' ' + this.getNumber();
            },
            getNumber: function() {
                return this.number;
            }
        });
        
        var Gallery = JS.Class(Paginator, {
            createItems: function(n) { this._super(4 * n); }
        });
        
        var ItemInheritor = JS.Class(Gallery);
        ItemInheritor.Item = JS.Class(Gallery.Item, {
            getNumber: function() { return this._super() + 7; }
        });
        
        //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        
        var Enum = JS.Module({
            each: function() {},
            some: function() {},
            
            included: function() {
                Enum.hasBeenIncluded = Enum.hasBeenIncluded || 0;
                Enum.hasBeenIncluded++;
            }
        });
        
        var ActiveRecord = JS.Module({
            include: Enum,
            
            save: function() {},
            validate: function() {},
            attributes: function() {},
            
            extend: {
                find: function() {},
                create: function() {}
            }
        });
        
        var BlankClass = JS.Class();
        BlankClass.include(ActiveRecord);
        
        //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        
        var InheritanceCatcher = JS.Class({
            extend: {
                inherited: function(klass) {
                    this.children.push(klass);
                    klass.log(this);
                },
                children: []
            }
        });
        
        //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        
        // A 'comparable' class whose instances can be compared and sorted
        var TodoItem = new JS.Class({
            include: JS.Comparable,
            
            initialize: function(position, task) {
                this.position = position;
                this.task = task || "";
            },
            
            compareWith: function(other) {
                if (this.position < other.position)
                    return -1;
                else if (this.position > other.position)
                    return 1;
                else
                    return 0;
            }
        });
        
        var Collection = new JS.Class({
            include: JS.Enumerable,
            initialize: function() {
              this.length = arguments.length;
              for (var i = 0, n = this.length; i < n; i++)
                this[i] = arguments[i];
            }
        });
        
        var PairedHash = new JS.Class({
            include: JS.Enumerable,
            initialize: function(object) {
                this._object = object || {};
            },
            each: function(block, context) {
                for (var key in this._object)
                    block.call(context || null, {key: key, value: this._object[key]});
            }
        });
        
        var KeyValueHash = new JS.Class({
            include: JS.Enumerable,
            initialize: function(object) {
                this._object = object || {};
            },
            each: function(block, context) {
                for (var key in this._object)
                    block.call(context || null, key, this._object[key]);
            },
            keys: function() {
                return this.map(function(key, value) { return key; });
            },
            values: function() {
                return this.collect(function(key, value) { return value; });
            }
        });
        
        //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        
        var Publisher = JS.Class({
            include: JS.Observable
        });
    </script>
</head>
<body>
    
    <div id="testlog"></div>
    
    <script type="text/javascript" charset="utf-8">
        
        new Test.Unit.Runner({
            
            testSuperSpeed: function() { with(this) {
                var yogi = new Bear('Yogi');
                benchmark(function() {
                    yogi.speak();
                }, 3000);
                var bobo = new NoSuperBear('Bobo');
                benchmark(function() {
                    bobo.speak();
                }, 3000);
            }},
            
            testClassDefinition: function() { with(this) {
                var frog = new Animal('Kermit');
                assertEqual('My name is Kermit and I like Ms. Piggy', frog.speak('Ms. Piggy'));
                assertEqual('Animal finds food', Animal.find('food'));
                assertEqual('Animal finds shelter and Animal creates shelter', Animal.create('shelter'));
            }},
            
            testEmptyClass: function() { with(this) {
                var klass = JS.Class();
                var instance = new klass;
                assert(instance.isA(klass));
            }},
            
            testInheritance: function() { with(this) {
                var yogi = new Bear('Yogi');
                assertEqual('MY NAME IS YOGI AND I LIKE PICNICS', yogi.speak('picnics'));
                assertEqual('Animal finds honey', Bear.find('honey'));
                assertEqual('Animal finds nothing and Animal creates nothing, but Bear creates other stuff', Bear.create('nothing'));
            }},
            
            testSingletonMethodInheritance: function() { with(this) {
                var rex = new Bear('rex');
                rex.extend({speak: function() {
                    return 'Guess what? ' + this._super();
                }});
                assertEqual('Guess what? MY NAME IS REX AND I LIKE WALKS', rex.speak('walks'));
            }},
            
            testInterfaces: function() { with(this) {
                assertRaise('Error', function() {
                  JS.Interface.ensure({}, Dog.Interface);
                });
                assert(Dog.Interface.test(new Dog('Rex')));
                assert(!Dog.Interface.test({}));
            }},
            
            testImplement: function() { with(this) {
                var I = new JS.Interface(['compareWith', 'lt', 'lte', 'gt', 'gte', 'eq']);
                assertRaise('Error', function() {
                    var klass = new JS.Class({implement: I,
                        initialize: function() {}
                    });
                });
                assertRaise('Error', function() {
                    var klass = new JS.Class({implement: [I],
                        compareWith: function() {}
                    });
                    klass.include(JS.Comparable);
                });
                var klass = new JS.Class({implement: [I],
                    include: JS.Comparable,
                    compareWith: function() {}
                });
            }},
            
            testSuperWithNoArguments: function() { with(this) {
                var brutus = new Pitbull('Brutus');
                assertEqual('My name is Brutus and I like biting', brutus.speak('biting'));
            }},
            
            // Avoid Crockford's problem: http://www.ajaxpath.com/javascript-inheritance
            testReassignedSuper: function() { with(this) {
                var top = new TopClass();
                assertEqual('TopClass(2) extends SubClass(2) extends BaseClass(2)', top.getName());
            }},
            
            testInheritanceFromNativeClass: function() { with(this) {
                var nat = new NativeClass();
                assertEqual('Native', nat.getName());
                var child = new ChildOfNativeClass();
                assertEqual('Native', child.getName());
                NativeClass.prototype.shout = function() { return 'Shouting!!'; };
                assertEqual('Shouting!!', child.shout());
                assert(child.isA(ChildOfNativeClass));
                assert(child.isA(NativeClass));
                assert(child.isA(Object));
                assert(!child.isA(Dog));
            }},
            
            testBinding: function() { with(this) {
                var rex = new Dog('Rex');
                var bark = rex.method('bark');
                assertEqual('Rex says WOOF!', bark());
                var brutus = new Pitbull('Brutus');
                assertEqual('Brutus says WOOF!', brutus.bark());
                bark = brutus.bark;
                assertEqual(' says WOOF!', bark());
                var bite = Pitbull.method('canBiteYourLegsOff');
                assertEqual('Of course it can', bite());
            }},
            
            testHierarchy: function() { with(this) {
                var rex = new Dog('Rex');
                assert(rex.isA(Dog));
                assert(rex.isA(Animal));
                assert(rex.isA(Object));
                assert(!rex.isA(Bear));
                var yogi = new rex.klass.superclass.subclasses[0]('Yogi');
                assertEqual('Yogi', yogi.name);
                assert(yogi.isA(Bear));
                assert(!yogi.isA(Dog));
            }},
            
            testSubclassUpdating: function() { with(this) {
                var kevin = new Koala('Kevin');
                Animal.instanceMethod('shout', function(thing) {
                    return this.name + ' is loving ' + thing + '!!!';
                });
                assertEqual('Kevin is loving trees!!!', kevin.shout('trees'));
                Animal.classMethod('count', function() { return 6; });
                assertEqual(4*6, Koala.count() + Bear.count() + Dog.count() + Pitbull.count());
            }},
            
            testClassMethodInheritanceSkipsGenerations: function() { with(this) {
                Dog.eatFood = function(food) { return 'Dogs eat ' + food; };
                assertEqual('Dogs eat biscuits', Dog.eatFood('biscuits'));
                Animal.classMethod('eatFood', function(food) { return 'Animals eat ' + food; });
                assertEqual('Animals eat people', Pitbull.eatFood('people'));
                assertEqual('Dogs eat biscuits', Dog.eatFood('biscuits'));
                Pitbull.classMethod('eatFood', function() { return this._super(); });
                assertEqual('Dogs eat people', Pitbull.eatFood('people'));
            }},
            
            testModularInheritance: function() { with(this) {
                var paginator = new Paginator(12);
                assert(paginator.isA(Paginator));
                assert(paginator.items[6].isA(Paginator.Item));
                assert(paginator.items[6].isA(paginator.items[3].klass));
                assertEqual('Item 7', paginator.items[7].getName());
                
                var gallery = new Gallery(3);
                assertEqual(12, gallery.items.length);
                assert(gallery.isA(Gallery));
                assert(gallery.isA(Paginator));
                assert(gallery.items[5].isA(Gallery.Item));
                assert(gallery.items[5].isA(Paginator.Item));
                
                assert(Paginator.Item === Gallery.Item);
                assert(ItemInheritor.Item !== Gallery.Item);
                assert(ItemInheritor.Item.superclass === Gallery.Item);
                
                var itor = new ItemInheritor(2);
                assertEqual('Item 13', itor.items[6].getName());
            }},
            
            testModule: function() { with(this) {
                assertEqual('function', typeof BlankClass.find);
                assertEqual('function', typeof BlankClass.create);
                var foo = new BlankClass;
                assertEqual('function', typeof foo.save);
                assertEqual('function', typeof foo.validate);
                assertEqual('function', typeof foo.attributes);
                assertEqual('function', typeof foo.each);
                assertEqual('function', typeof foo.some);
                assertEqual(1, Enum.hasBeenIncluded);
            }},
            
            testSingleton: function() { with(this) {
                var bear = JS.Singleton(Bear, {
                    roar: function() { return this.noise; },
                    noise: 'ROAR'
                });
                assertEqual(Bear, bear.klass.superclass);
                var roar = bear.method('roar');
                assertEqual('ROAR', roar());
            }},
            
            testSingletonReinstantiation: function() { with(this) {
                assertRaise('Error', function() {
                    var foo = new Camel.klass('Cyril');
                });
            }},
            
            testInheritedHook: function() { with(this) {
                var foo = JS.Class(InheritanceCatcher, {
                    extend: {
                        log: function(klass) {}
                    }
                });
                assertEqual(foo, InheritanceCatcher.children[0]);
            }},
            
            testMethodChain: function() { with(this) {
                var chain = new JS.MethodChain(['foo', 'bar']);
                chain.map(function(s) { return s.toUpperCase() })
                        .join(", ").replace(/[aeiou]/ig, "_");
                assertEqual("F__, B_R", chain.fire());
                assertEqual("S_M_TH_NG, _LS_", chain.fire(['something', 'else']));
            }},
            
            testComparableModule: function() { with(this) {
                var items = [8,2,7,5,3,7,6].map(function(id) { return new TodoItem(id) });
                var sorted = items.clone().sort(TodoItem.compare);
                assertEqual('2,3,5,6,7,7,8', sorted.pluck('position').join(','));
                assert(items[1].lt(items[6]));
                assert(items[3].lte(items[2]));
                assert(items[0].gt(items[4]));
                assert(items[2].gte(items[5]));
                assert(items[5].eq(items[2]));
                assert(items[3].between(items[4], items[2]));
            }},
            
            testEnumerableModule: function() {
                var foo = [1,2,3,4,5,6], results;
                var collection = new Collection(1,2,3,4,5,6);
                
                results = ['1,2,3,4', '2,3,4,5', '3,4,5,6'];
                collection.eachCons(4, function(set, i) {
                    this.assertEqual(results[i], set.join(','));
                }, this);
                
                results = ['1,2,3', '4,5,6', '7,8,9', '10'];
                new Collection(1,2,3,4,5,6,7,8,9,10).eachSlice(3, function(set, i) {
                    this.assertEqual(results[i], set.join(','));
                }, this);
                
                collection.each(function(x,i) {
                    this.assertEqual(foo[i], x);
                }, this);
                
                this.assertEqual(61, collection.inject(40, function(memo, item) { return memo + item; }));
                this.assertEqual(36, collection.inject(0, function(memo, item, i) { return memo + item + i; }));
                this.assertEqual(21, collection.inject(function(memo, item) { return memo + item; }));
                
                this.x = 4;
                this.assertEqual(81, collection.inject(function(memo, item) { return memo + this.x * item; }, this));
                this.assertEqual(24, collection.inject(-60, function(memo, item) { return memo + this.x * item; }, this));
                
                this.assert(collection.all(function(item, i) { return item == i + 1 }));
                this.assert(collection.member(4));
                this.assert(!collection.member('jam'));
                
                this.assertEqual('1,2', collection.partition(function(x) { return x <= 2 })[0].join(','));
                this.assertEqual('3,4,5,6', collection.partition(function(x) { return x <= 2 })[1].join(','));
                
                this.assert(collection.any(function(item) { return item == 3 }));
                this.assert(!collection.any(function(item, i) { return item == i }));
                this.assert(collection.any(function(item, i) { return item == i + 1 }));
                this.assert(collection.any(function(item) { return item == this.x }, this));
                this.assert(!collection.any(function(item) { return item == 9 }));
                
                this.assertEqual(3, collection.detect(function(x) { return x % 3 === 0 }));
                this.assertEqual(5, collection.find(function(x) { return x % 5 === 0 }));
                this.assertEqual(null, collection.find(function(x) { return x % 12 === 0 }));
                this.assertEqual(4, collection.detect(function(x) { return x * 8 === 32 }));
                
                this.assertEqual('5,6', collection.select(function(x) { return x > 4 }).join(','));
                
                this.assertEqual('1,2,3,4,5,6', collection.entries().join(','));
                
                var zip = collection.zip([8,2,7,6], ['cat', 'dog', 'mouse']);
                results = ['1,8,cat', '2,2,dog', '3,7,mouse', '4,6,', '5,,', '6,,'];
                zip.each(function(item,i) {
                    this.assertEqual(results[i], item.join(','));
                }, this);
                
                collection.zip([8,2,7,6], ['cat', 'dog', 'mouse'], function(ary, i) {
                    this.assertEqual(results[i], ary.join(','));
                }, this);
                
                this.assertIdentical(false, new Collection(1,2,3).zip([true, false, true])[1][1]);
                
                collection = new Collection(
                    new TodoItem(8, 'Play golf'),
                    new TodoItem(5, 'Go to work'),
                    new TodoItem(7, 'Make money'),
                    new TodoItem(3, 'Have nap'),
                    new TodoItem(4, 'Organise to-do list')
                );
                
                this.method = 'compareWith';
                this.assertEqual('3,4,5,7,8', collection.sort().pluck('position').join(','));
                this.assertEqual('Have nap', collection.min().task);
                this.assertEqual('Play golf', collection.max().task);
                this.assertEqual('8,7,5,4,3', collection.sort(function(a,b) { return b[this.method](a) }, this).pluck('position').join(','));
                this.assertEqual(3, collection.max(function(a,b) { return b[this.method](a) }, this).position);
                this.assertEqual(8, new Collection(1,8,3,7,5).max());
                this.assertEqual('comes', new Collection('something', 'wicked', 'comes', 'this', 'way').min());
                this.assertEqual('3,4,5,7,8', new Collection(8,5,7,3,4).sort().join(','));
                this.assertEqual('8,7,5,4,3', new Collection(8,5,7,3,4).sort(function(a,b) { return (1/a) - (1/b) }).join(','));
                
                this.field = 'task';
                this.assertEqual("Go to work, Have nap, Make money, Organise to-do list, Play golf",
                        collection.sortBy(function(item) { return item[this.field]; }, this).pluck('task').join(', '));
                
                this.assertEqual("3,4,5,7,8",
                        collection.sortBy(function(item) { return item; }).pluck('position').join(','));
            },
            
            testEachConsSpeed: function() { with(this) {
                benchmark(function() {
                //    new Collection(1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6).eachCons(3, function(){});
                }, 300);
            }},
            
            testHashes: function() {
                var hash1 = new PairedHash({foo: 'foo', bar: 'bar'});
                hash1.inject(function(memo, pair, index) {
                    this.assert(pair.key && typeof pair.value == 'string');
                    this.assertEqual(undefined, index);
                }, this);
                
                var hash2 = new KeyValueHash({foo: 'foo', bar: 'bar'});
                hash2.inject(function(memo, key, value) {
                    this.assert(typeof key == 'string' && typeof value == 'string');
                }, this);
                
                var obj = hash2.inject({}, function(memo, key, value) {
                    memo[key] = value.toUpperCase();
                    return memo;
                });
                this.assertEqual('FOO', obj.foo);
                this.assertEqual('BAR', obj.bar);
                
                var hash3 = new KeyValueHash({foo: 'foo', bar: 'bar', fizz: 'buzz'});
                this.assert(hash3.any(function(key, value) { return key == value; }));
                this.assert(!hash3.all(function(key, value) { return key == value; }));
                this.assert(hash2.all(function(key, value) { return key == value; }));
                
                this.assertEqual('bar,fizz,foo', hash3.keys().sort().join(','));
                this.assertEqual('bar,buzz,foo', hash3.values().sort().join(','));
            },
            
            testObservableModule: function() { with(this) {
                var pub = new Publisher;
                this.counter = 0;
                var increment = function() { this.counter++ };
                pub.subscribe(increment, this);
                pub.subscribe(function(x) { this.counter += x }, this);
                pub.notifyObservers(4);
                assertEqual(5, this.counter);
                pub.unsubscribe(increment);
                pub.unsubscribe(increment);
                pub.notifyObservers(9);
                assertEqual(14, this.counter);
                pub.setChanged(false);
                pub.notifyObservers(905);
                assertEqual(14, this.counter);
                pub.setChanged();
                pub.notifyObservers(905);
                assertEqual(919, this.counter);
            }}
        });
        
    </script>
</body>
</html>
