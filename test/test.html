<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>JS.Class tests</title>
    <script src="prototype.js" type="text/javascript" charset="utf-8"></script>
    <script src="unittest.js" type="text/javascript" charset="utf-8"></script>
    <script src="../build/class.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="test.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <script type="text/javascript" charset="utf-8">
    
    //================================================================
    // Test that method inheritance works as it does in Ruby.
    // See module.rb for equivalent Ruby code
    //================================================================
    
    var ModA = new JS.Module({
        speak: function() {
            return "speak() in ModA";
        }
    });
    
    var ModB = new JS.Module({
        speak: function() {
            return "speak() in ModB, " + this.callSuper();
        }
    });
    
    var ModC = new JS.Module();
    ModC.include(ModA);
    ModC.include({
        speak: function() {
            return this.callSuper() + ", and in ModC";
        }
    });
    ModC.include(ModB);
    
    var InheritanceTester = new JS.Class({
        initialize: function() {},
        
        speak: function() {
            return this.callSuper() + ", and in class Foo";
        }
    });
    InheritanceTester.include(ModC);
    
    var SpecialClass = new JS.Class(JS.Class, {
        make: function(name, func) {
            return [name, this.callSuper()];
        }
    });
    
    var Special = new SpecialClass(InheritanceTester, {
        speak: function() {
            return this.callSuper().toUpperCase();
        }
    });
    
    </script>
</head>
<body>
    
    <div id="testlog"></div>
    
    <script type="text/javascript" charset="utf-8">
        
    new Test.Unit.Runner({
        testRubyishInheritance: function() { with(this) {
            var tester = new InheritanceTester();
            assertEqual("speak() in ModB, speak() in ModA, and in ModC, and in class Foo", tester.speak());
        }},
        
        testCoreClasses: function() { with(this) {
            assertEqual(JS.Class, JS.Module.klass);
            assertEqual(JS.Class, JS.Class.klass);
            assertEqual(1, JS.Module.subclasses.length);
            assertEqual(JS.Class, JS.Module.subclasses[0]);
            assertEqual(Object, JS.Module.superclass);
            assertEqual(1, JS.Class.subclasses.length);
            assertEqual(SpecialClass, JS.Class.subclasses[0]);
            assertEqual(JS.Module, JS.Class.superclass);
        }},
        
        testInheritanceFromClass: function() { with(this) {
            assertEqual(JS.Class, SpecialClass.klass);
            assertEqual(JS.Class, SpecialClass.superclass);
            assertEqual(JS.Class, Special.klass);
            assertEqual(InheritanceTester, Special.superclass)
            var things = Special.make('something', function() { return 'else' });
            assertEqual('something', things[0]);
            assertEqual('else', things[1]());
            assertEqual("speak() in ModB, speak() in ModA, and in ModC, and in class Foo".toUpperCase(), new Special().speak());
        }},
        
        testIsA: function() { with(this) {
            var obj = new InheritanceTester();
            assert(obj.isA(InheritanceTester));
            assert(obj.isA(ModA));
            assert(obj.isA(ModB));
            assert(obj.isA(ModC));
            assert(obj.isA(JS.ObjectMethods));
            assert(obj.isA(Object));
            obj = new Special();
            assert(obj.isA(Special));
            assert(obj.isA(InheritanceTester));
            assert(obj.isA(ModA));
            assert(obj.isA(ModB));
            assert(obj.isA(ModC));
            assert(obj.isA(JS.ObjectMethods));
            assert(obj.isA(Object));
            assert(!obj.isA(JS.Class));
            assert(!obj.isA(JS.Module));
            var SomeClass = new JS.Class({ initialize: function(){} });
            assert(SomeClass.isA(JS.Class));
            assert(SomeClass.isA(JS.Module));
            assert(!(new SomeClass).isA(InheritanceTester));
        }},
        
        testExtend: function() { with(this) {
            var obj = new InheritanceTester();
            var i = 0;
            for (var key in obj) { if (obj.hasOwnProperty(key)) i++; }
            assertEqual(0, i);
            obj.extend({
                speak: function() {
                    return this.callSuper().replace(/[aeiou]/ig, '_');
                }
            });
            var keys = [];
            for (var key in obj) { if (obj.hasOwnProperty(key)) keys.push(key); }
            assertEqual(2, keys.length);
            keys.sort();
            assertEqual('__meta__', keys[0]);
            assertEqual('speak', keys[1]);
            assertEqual("sp__k() _n M_dB, sp__k() _n M_d_, _nd _n M_dC, _nd _n cl_ss F__", obj.speak());
        }}
    });
        
    </script>
</body>
</html>
