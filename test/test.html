<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>JS.Class tests</title>
    <script src="prototype.js" type="text/javascript" charset="utf-8"></script>
    <script src="unittest.js" type="text/javascript" charset="utf-8"></script>
    <script src="../build/class.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="test.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <script type="text/javascript" charset="utf-8">
    
    //================================================================
    // Test that method inheritance works as it does in Ruby.
    // See module.rb for equivalent Ruby code
    //================================================================
    
    var ModA = new JS.Module({
        speak: function() {
            return "speak() in ModA";
        },
        extend: {
            included: function(mod) {
                this.incs = this.incs || [];
                this.incs.push(mod);
            },
            
            extended: function(mod) {
                this.exts = this.exts || [];
                this.exts.push(mod);
            }
        }
    });
    
    var ModB = new JS.Module({
        speak: function() {
            return "speak() in ModB, " + this.callSuper();
        }
    });
    
    var ModC = new JS.Module();
    ModC.include({
        include: ModA,
        speak: function() {
            return this.callSuper() + ", and in ModC";
        }
    });
    ModC.include(ModB);
    ModC.included = ModA.included;
    
    var InheritanceTester = new JS.Class({
        include: ModC,
        
        initialize: function() {},
        
        speak: function() {
            return this.callSuper() + ", and in class Foo";
        },
        
        extend: {
            children: [],
            inherited: function(klass) {
                this.children.push(klass);
            }
        }
    });
    
    var SingletonMethodTester = new JS.Class({
        speak: function() {
            return "speak() in class Bar";
        }
    });
    
    var SpecialClass = new JS.Class(JS.Class, {
        make: function(name, func) {
            return [name, this.callSuper()];
        }
    });
    
    var Special = new SpecialClass(InheritanceTester, {
        speak: function() {
            return this.callSuper().toUpperCase();
        }
    });
    
    var HookTester = new JS.Class(InheritanceTester);
    
    JS.extend(Object, {
        children: [],
        inherited: function(klass) {
            this.children.push(klass);
        }
    });
    
    //================================================================
    //================================================================
    
    var Animal = new JS.Class({
        extend: {
            find: function(thing) { return 'Animal finds ' + thing; },
            create: function(thing) { return this.find(thing) + ' and Animal creates ' + thing; }
        },
        initialize: function(name) {
            this.name = String(name);
        },
        speak: function(stuff) {
            return 'My name is ' + this.name + ' and I like ' + stuff;
        }
    });

    var Bear = new JS.Class(Animal, {
        extend: {
            create: function(thing) {
                return this.callSuper(thing) + ', but Bear creates other stuff'
            }
        },
        speak: function(stuff) {
            return this.callSuper(stuff).toUpperCase();
        }
    });

    var NoSuperBear = new JS.Class(Bear, {
        speak: function() { return this.name.toUpperCase(); }
    });

    var Koala = new JS.Class(Bear, {
        speak: function(stuff) {
            return "I'm not really a Bear, but I do like " + stuff;
        }
    });

    var Dog = new JS.Class(Animal, {
        bark: function() { return this.name + ' says WOOF!'; }
    });

    Dog.Interface = new JS.Interface(['speak', 'bark']);

    var Pitbull = new JS.Class(Dog, {
        extend: {
            canBiteYourLegsOff: function() {
                return this.biting;
            },
            biting: 'Of course it can'
        },
        speak: function() {
            return this.callSuper();
        }
    });

    var Camel = new JS.Singleton(Animal, {
        fillHumpsWithWater: function() {}
    });

    //================================================================
    // Let's implement the classes from here: http://www.ajaxpath.com/javascript-inheritance
    // and make sure Crockford's problems aren't encountered.
    //================================================================
    
    var BaseClass = new JS.Class({
        getName: function() { return 'BaseClass(' + this.getId() + ')'; },
        getId: function() { return 1; }
    });

    var SubClass = new JS.Class(BaseClass, {
        getName: function() {
            return 'SubClass(' + this.getId() + ') extends ' + this.callSuper();
        },
        getId: function() { return 2; }
    });

    var TopClass = new JS.Class(SubClass, {
        getName: function() {
            return 'TopClass(' + this.getId() + ') extends ' + this.callSuper();
        },
        getId: function() {
            return this.callSuper();
        }
    });

    //================================================================
    //================================================================

    var NativeClass = function() {};
    NativeClass.prototype = {
        getName: function() { return 'Native'; }
    };

    var ChildOfNativeClass = new JS.Class(NativeClass, {
        getName: function() {
            return this.callSuper();
        }
    });
    
    //================================================================
    //================================================================

    var Paginator = new JS.Class({
        initialize: function(n) {
            this.count = n;
            this.createItems(n);
        },
        createItems: function(n) {
            this.items = this.items || [];
            for (var i = 0; i < n; i++)
                this.items.push(new this.klass.Item(i));
        }
    });
    
    Paginator.extend({Item: new JS.Class({
        initialize: function(n) {
            this.name = 'Item';
            this.number = n;
        },
        getName: function() {
            return this.name + ' ' + this.getNumber();
        },
        getNumber: function() {
            return this.number;
        }
    }) });
    
    var Gallery = new JS.Class(Paginator, {
        createItems: function(n) { this.callSuper(4 * n); }
    });
    
    var ItemInheritor = new JS.Class(Gallery);
    ItemInheritor.Item = new JS.Class(Gallery.Item, {
        getNumber: function() { return this.callSuper() + 7; }
    });
    
    //================================================================
    //================================================================

    var Enum = new JS.Module({
        each: function() {},
        some: function() {},
        
        extend: {
            included: function() {
                this.hasBeenIncluded = this.hasBeenIncluded || 0;
                this.hasBeenIncluded++;
            }
        }
    });
    
    var ActiveRecord = new JS.Module({
        include: Enum,
        
        save: function() {},
        validate: function() {},
        attributes: function() {},
        
        extend: {
            included: function(base) {
                base.extend({
                    find: function() {},
                    create: function() {}
                });
            }
        }
    });
    
    var BlankClass = new JS.Class();
    BlankClass.include(ActiveRecord);
    
    </script>
</head>
<body>
    
    <div id="testlog"></div>
    
    <script type="text/javascript" charset="utf-8">
        
    new Test.Unit.Runner({
        testRubyishInheritance: function() { with(this) {
            var tester = new InheritanceTester();
            assertEqual("speak() in ModB, speak() in ModA, and in ModC, and in class Foo", tester.speak());
            
            tester = new SingletonMethodTester();
            assertEqual('speak() in class Bar', tester.speak());
            tester.extend({speak: function() {
                return this.callSuper().toUpperCase()
            } });
            assertEqual('SPEAK() IN CLASS BAR', tester.speak());
            tester.extend(ModB);
            assertEqual('SPEAK() IN MODB, SPEAK() IN CLASS BAR', tester.speak());
        }},
        
        testCoreClasses: function() { with(this) {
            assertEqual(JS.Class, JS.Module.klass);
            assertEqual(JS.Class, JS.Class.klass);
            assertEqual(1, JS.Module.subclasses.length);
            assertEqual(JS.Class, JS.Module.subclasses[0]);
            assertEqual(Object, JS.Module.superclass);
            assertEqual(1, JS.Class.subclasses.length);
            assertEqual(SpecialClass, JS.Class.subclasses[0]);
            assertEqual(JS.Module, JS.Class.superclass);
        }},
        
        testInheritanceFromClass: function() { with(this) {
            assertEqual(JS.Class, SpecialClass.klass);
            assertEqual(JS.Class, SpecialClass.superclass);
            assertEqual(JS.Class, Special.klass);
            assertEqual(InheritanceTester, Special.superclass)
            var things = Special.make('something', function() { return 'else' });
            assertEqual('something', things[0]);
            assertEqual('else', things[1]());
            assertEqual("speak() in ModB, speak() in ModA, and in ModC, and in class Foo".toUpperCase(), new Special().speak());
        }},
        
        testIsA: function() { with(this) {
            var obj = new InheritanceTester();
            assert(obj.isA(InheritanceTester));
            assert(obj.isA(ModA));
            assert(obj.isA(ModB));
            assert(obj.isA(ModC));
            assert(obj.isA(JS.ObjectMethods));
            assert(obj.isA(Object));
            
            obj = new Special();
            assert(obj.isA(Special));
            assert(obj.isA(InheritanceTester));
            assert(obj.isA(ModA));
            assert(obj.isA(ModB));
            assert(obj.isA(ModC));
            assert(obj.isA(JS.ObjectMethods));
            assert(obj.isA(Object));
            
            assert(!obj.isA(JS.Class));
            assert(!obj.isA(JS.Module));
            
            var SomeClass = new JS.Class({ initialize: function(){} });
            assert(InheritanceTester.isA(JS.Class));
            assert(InheritanceTester.isA(JS.Module));
            assert(Special.isA(JS.Class));
            assert(Special.isA(JS.Module));
            assert(!(new SomeClass).isA(InheritanceTester));
            
            assert(JS.Module.isA(JS.Module));
            assert(JS.Module.isA(JS.Class));
            assert(JS.Class.isA(JS.Module));
            assert(JS.Class.isA(JS.Class));
        }},
        
        testExtend: function() { with(this) {
            var obj = new InheritanceTester();
            var i = 0;
            for (var key in obj) { if (obj.hasOwnProperty(key)) i++; }
            assertEqual(0, i);
            obj.extend({
                speak: function() {
                    return this.callSuper().replace(/[aeiou]/ig, '_');
                }
            });
            var keys = [];
            for (var key in obj) { if (obj.hasOwnProperty(key)) keys.push(key); }
            assertEqual(2, keys.length);
            keys.sort();
            assertEqual('__meta__', keys[0]);
            assertEqual('speak', keys[1]);
            assertEqual("sp__k() _n M_dB, sp__k() _n M_d_, _nd _n M_dC, _nd _n cl_ss F__", obj.speak());
        }},
        
        testTypeDetectionOnExtendedObjects: function() { with(this) {
            var mod = new JS.Module({
                jabba: function() { return 'It says JABBA!' }
            });
            var klass = new JS.Class();
            assert(!klass.isA(mod));
            klass.extend(mod);
            assert(klass.isA(mod));
            assertEqual('It says JABBA!', klass.jabba());
            var obj = new klass;
            assertEqual(undefined, obj.jabba);
            assert(!obj.isA(mod));
            assert(obj.isA(klass));
            obj.extend(mod);
            assert(obj.isA(mod));
            assertEqual('It says JABBA!', obj.jabba());
        }},
        
        testHooks: function() { with(this) {
            assertEqual(1, ModA.incs.length);
            assertEqual(ModC, ModA.incs[0]);
            var obj = new JS.Interface(['foo']);
            obj.extend(ModA);
            assertEqual(1, ModA.exts.length);
            assertEqual(obj, ModA.exts[0]);
            assertEqual(1, ModC.incs.length);
            assertEqual(InheritanceTester, ModC.incs[0]);
            var klass = new JS.Class();
            klass.extend(ModA);
            assertEqual('speak() in ModA', klass.speak());
            assertEqual(2, ModA.exts.length);
            assertEqual(klass, ModA.exts[1]);
        }},
        
        testClassDefinition: function() { with(this) {
            var frog = new Animal('Kermit');
            assertEqual('My name is Kermit and I like Ms. Piggy', frog.speak('Ms. Piggy'));
            assertEqual('Animal finds food', Animal.find('food'));
            assertEqual('Animal finds shelter and Animal creates shelter', Animal.create('shelter'));
        }},
        
        testEmptyClass: function() { with(this) {
            var klass = new JS.Class();
            var instance = new klass;
            assert(instance.isA(klass));
        }},
        
        testInheritance: function() { with(this) {
            var yogi = new Bear('Yogi');
            assertEqual('MY NAME IS YOGI AND I LIKE PICNICS', yogi.speak('picnics'));
            assertEqual('Animal finds honey', Bear.find('honey'));
            assertEqual('Animal finds nothing and Animal creates nothing, but Bear creates other stuff', Bear.create('nothing'));
        }},
        
        testSingletonMethodInheritance: function() { with(this) {
            var rex = new Bear('rex');
            rex.extend({speak: function() {
                return 'Guess what? ' + this.callSuper();
            }});
            assertEqual('Guess what? MY NAME IS REX AND I LIKE WALKS', rex.speak('walks'));
        }},
        
        testInterfaces: function() { with(this) {
            assertRaise('Error', function() {
              JS.Interface.ensure({}, Dog.Interface);
            });
            assert(Dog.Interface.test(new Dog('Rex')));
            assert(!Dog.Interface.test({}));
        }},
        
        testSuperWithNoArguments: function() { with(this) {
            var brutus = new Pitbull('Brutus');
            assertEqual('My name is Brutus and I like biting', brutus.speak('biting'));
        }},
        
        // Avoid Crockford's problem: http://www.ajaxpath.com/javascript-inheritance
        testReassignedSuper: function() { with(this) {
            var top = new TopClass();
            assertEqual('TopClass(2) extends SubClass(2) extends BaseClass(2)', top.getName());
        }},
        
        testInheritanceFromNativeClass: function() { with(this) {
            var nat = new NativeClass();
            assertEqual('Native', nat.getName());
            child = new ChildOfNativeClass();
            assertEqual('Native', child.getName());
            NativeClass.prototype.shout = function() { return 'Shouting!!'; };
            assertEqual('Shouting!!', child.shout());
            assert(child.isA(ChildOfNativeClass));
            assert(child.isA(NativeClass));
            assert(child.isA(Object));
            assert(!child.isA(Dog));
        }},
        
        testBinding: function() { with(this) {
            var rex = new Dog('Rex');
            var bark = rex.method('bark');
            assertEqual('Rex says WOOF!', bark());
            var brutus = new Pitbull('Brutus');
            assertEqual('Brutus says WOOF!', brutus.bark());
            bark = brutus.bark;
            assertEqual(' says WOOF!', bark());
            var bite = Pitbull.method('canBiteYourLegsOff');
            assertEqual('Of course it can', bite());
        }},
        
        testMethodMemoization: function() { with(this) {
            var dog = new Dog('Oscar');
            var bark = dog.method('bark');
            assertEqual(bark, dog.method('bark'));
            dog.extend({
              bark: function() {
                return this.callSuper() + ' and has his own bark() method.';
              }
            });
            assertEqual('Oscar says WOOF! and has his own bark() method.', dog.bark());
            assert(dog.method('bark') != bark);
            assert(dog.method('bark') == dog.method('bark'));
        }},
        
        testHierarchy: function() { with(this) {
            var rex = new Dog('Rex');
            assert(rex.isA(Dog));
            assert(rex.isA(Animal));
            assert(rex.isA(Object));
            assert(!rex.isA(Bear));
            var yogi = new rex.klass.superclass.subclasses[0]('Yogi');
            assertEqual('Yogi', yogi.name);
            assert(yogi.isA(Bear));
            assert(!yogi.isA(Dog));
        }},
        
        testSubclassUpdating: function() { with(this) {
            var kevin = new Koala('Kevin');
            Animal.include({shout: function(thing) {
                return this.name + ' is loving ' + thing + '!!!';
            }});
            assertEqual('Kevin is loving trees!!!', kevin.shout('trees'));
            Animal.extend({count: function() { return 6; }});
            assertEqual(4*6, Koala.count() + Bear.count() + Dog.count() + Pitbull.count());
        }},
        
        testClassMethodInheritanceSkipsGenerations: function() { with(this) {
            Dog.eatFood = function(food) { return 'Dogs eat ' + food; };
            assertEqual('Dogs eat biscuits', Dog.eatFood('biscuits'));
            Animal.extend({eatFood: function(food) { return 'Animals eat ' + food; }});
            assertEqual('Animals eat people', Pitbull.eatFood('people'));
            assertEqual('Dogs eat biscuits', Dog.eatFood('biscuits'));
            Pitbull.extend({eatFood: function() { return this.callSuper(); }});
            assertEqual('Dogs eat people', Pitbull.eatFood('people'));
        }},
        
        testModularInheritance: function() { with(this) {
            var paginator = new Paginator(12);
            assert(paginator.isA(Paginator));
            assert(paginator.items[6].isA(Paginator.Item));
            assert(paginator.items[6].isA(paginator.items[3].klass));
            assertEqual('Item 7', paginator.items[7].getName());
            
            var gallery = new Gallery(3);
            assertEqual(12, gallery.items.length);
            assert(gallery.isA(Gallery));
            assert(gallery.isA(Paginator));
            assert(gallery.items[5].isA(Gallery.Item));
            assert(gallery.items[5].isA(Paginator.Item));
            
            assert(Paginator.Item === Gallery.Item);
            assert(ItemInheritor.Item !== Gallery.Item);
            assert(ItemInheritor.Item.superclass === Gallery.Item);
            
            var itor = new ItemInheritor(2);
            assertEqual('Item 13', itor.items[6].getName());
        }},
        
        testModule: function() { with(this) {
            assertEqual('function', typeof BlankClass.find);
            assertEqual('function', typeof BlankClass.create);
            var foo = new BlankClass;
            assertEqual('function', typeof foo.save);
            assertEqual('function', typeof foo.validate);
            assertEqual('function', typeof foo.attributes);
            assertEqual('function', typeof foo.each);
            assertEqual('function', typeof foo.some);
            assertEqual(1, Enum.hasBeenIncluded);
        }},
        
        testSingleton: function() { with(this) {
            var bear = new JS.Singleton(Bear, {
                roar: function() { return this.noise; },
                noise: 'ROAR'
            });
            assertEqual(Bear, bear.klass.superclass);
            var roar = bear.method('roar');
            assertEqual('ROAR', roar());
        }},
        
        testInheritedHook: function() { with(this) {
            var foo = new JS.Class(HookTester, {
                extend: {
                    log: function(klass) {}
                }
            });
            assert(Object.children.length > 0);
            assertEqual(Special, InheritanceTester.children[0]);
            assertEqual(HookTester, InheritanceTester.children[1]);
            assertEqual(foo, InheritanceTester.children[2]);
        }}
    });
        
    </script>
</body>
</html>
